<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMS RAG - DuploCloud RAG Example</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-chat-left-text-fill"></i> SMS RAG Interface</h1>
            <div>
                <a href="/" class="btn btn-outline-secondary">
                    <i class="bi bi-house-door"></i> Home
                </a>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-phone"></i> Send SMS
                    </div>
                    <div class="card-body">
                        <form id="sms-form">
                            <div class="mb-3">
                                <label for="phone-number" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="phone-number" placeholder="+1234567890" required>
                                <div class="form-text">Enter phone number in international format (e.g., +1234567890)</div>
                            </div>
                            <div class="mb-3">
                                <label for="query" class="form-label">Query</label>
                                <textarea class="form-control" id="query" rows="3" placeholder="Enter your question here..." required></textarea>
                            </div>

                            <div class="accordion mb-3" id="advancedSettingsAccordion">
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingAdvancedSettings">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAdvancedSettings">
                                            Advanced Settings
                                        </button>
                                    </h2>
                                    <div id="collapseAdvancedSettings" class="accordion-collapse collapse" data-bs-parent="#advancedSettingsAccordion">
                                        <div class="accordion-body">
                                            <div class="mb-3">
                                                <label for="model-select" class="form-label">LLM Model</label>
                                                <select class="form-select" id="model-select">
                                                    <option value="">Default model</option>
                                                    <!-- Models will be loaded dynamically -->
                                                </select>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="web-search" checked>
                                                        <label class="form-check-label" for="web-search">
                                                            Enable Web Search
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="enhance-query" checked>
                                                        <label class="form-check-label" for="enhance-query">
                                                            Enhance Query
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="reranking" checked>
                                                        <label class="form-check-label" for="reranking">
                                                            Apply Reranking
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="hybrid-search" checked>
                                                        <label class="form-check-label" for="hybrid-search">
                                                            Hybrid Search
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="combine-chunks" checked>
                                                        <label class="form-check-label" for="combine-chunks">
                                                            Combine Chunks
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="question-matches" checked>
                                                        <label class="form-check-label" for="question-matches">
                                                            Check Question Matches
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="n-results" class="form-label">Results Count</label>
                                                    <input type="number" class="form-control" id="n-results" value="3" min="1" max="10">
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="web-results-count" class="form-label">Web Results Count</label>
                                                    <input type="number" class="form-control" id="web-results-count" value="3" min="1" max="10">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary" id="send-button">
                                    <span id="send-spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                    Send SMS
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card mt-3 d-none" id="quota-card">
                    <div class="card-header bg-info text-white">
                        <i class="bi bi-info-circle"></i> SMS Quota Information
                    </div>
                    <div class="card-body" id="quota-info">
                        <!-- Quota information will be displayed here -->
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-envelope-fill"></i> SMS History
                    </div>
                    <div class="card-body">
                        <div id="sms-history" class="mb-3">
                            <div class="alert alert-info">
                                Send an SMS to see the history here. History is only stored for this session.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-3 d-none" id="response-card">
                    <div class="card-header bg-light">
                        <i class="bi bi-info-circle"></i> Response Details
                    </div>
                    <div class="card-body">
                        <div id="response-details">
                            <!-- Response details will be shown here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/sources.js"></script>
    <script src="/static/js/models.js"></script>
    <script src="/static/js/openai.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Form elements
            const smsForm = document.getElementById('sms-form');
            const phoneNumberInput = document.getElementById('phone-number');
            const queryInput = document.getElementById('query');
            const modelSelect = document.getElementById('model-select');
            const webSearchCheck = document.getElementById('web-search');
            const enhanceQueryCheck = document.getElementById('enhance-query');
            const rerankingCheck = document.getElementById('reranking');
            const hybridSearchCheck = document.getElementById('hybrid-search');
            const combineChunksCheck = document.getElementById('combine-chunks');
            const questionMatchesCheck = document.getElementById('question-matches');
            const nResultsInput = document.getElementById('n-results');
            const webResultsCountInput = document.getElementById('web-results-count');
            const sendButton = document.getElementById('send-button');
            const sendSpinner = document.getElementById('send-spinner');
            
            // Result display elements
            const smsHistory = document.getElementById('sms-history');
            const responseCard = document.getElementById('response-card');
            const responseDetails = document.getElementById('response-details');
            const quotaCard = document.getElementById('quota-card');
            const quotaInfo = document.getElementById('quota-info');
            
            // In-memory history for this session
            const smsHistoryItems = [];
            
            // Load models using Models utility
            try {
                // Fetch models
                const data = await API.getModels();
                
                if (data.status === 'success' && data.models) {
                    // Clear existing options except the default one
                    while (modelSelect.options.length > 1) {
                        modelSelect.remove(1);
                    }
                    
                    // Add options for each model
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading models:', error);
            }
            
            // Check SMS quota on page load
            try {
                await checkQuota();
            } catch (error) {
                console.error('Error checking quota:', error);
            }
            
            // Send SMS form submission
            smsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Validate inputs
                const phoneNumber = phoneNumberInput.value.trim();
                const query = queryInput.value.trim();
                
                if (!phoneNumber) {
                    showAlert('Please enter a valid phone number', 'danger');
                    return;
                }
                
                if (!query) {
                    showAlert('Please enter a query', 'danger');
                    return;
                }
                
                // Show spinner and disable button
                sendSpinner.classList.remove('d-none');
                sendButton.disabled = true;
                
                // Prepare request data
                const requestData = {
                    phone: phoneNumber,
                    query: query,
                    n_results: parseInt(nResultsInput.value) || 3,
                    combine_chunks: combineChunksCheck.checked,
                    web_search: webSearchCheck.checked,
                    web_results_count: parseInt(webResultsCountInput.value) || 3,
                    enhance_query: enhanceQueryCheck.checked,
                    hybrid_search: hybridSearchCheck.checked,
                    apply_reranking: rerankingCheck.checked,
                    check_question_matches: questionMatchesCheck.checked
                };
                
                // Add model if selected
                if (modelSelect.value) {
                    requestData.model = modelSelect.value;
                }
                
                try {
                    // Send SMS request
                    const response = await fetch('/api/sms', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    const result = await response.json();
                    
                    // Add to history
                    const timestamp = new Date().toLocaleTimeString();
                    smsHistoryItems.unshift({
                        timestamp,
                        phone: phoneNumber,
                        query,
                        response: result
                    });
                    
                    // Update history display
                    updateSmsHistory();
                    
                    // Show response details
                    showResponseDetails(result);
                    
                    // Check quota after sending
                    await checkQuota();
                    
                    // Show success message
                    if (result.status === 'success') {
                        showAlert(`SMS sent successfully to ${phoneNumber}`, 'success');
                    } else {
                        showAlert(`Error sending SMS: ${result.message}`, 'danger');
                    }
                    
                } catch (error) {
                    console.error('Error sending SMS:', error);
                    showAlert(`Error sending SMS: ${error.message}`, 'danger');
                } finally {
                    // Hide spinner and enable button
                    sendSpinner.classList.add('d-none');
                    sendButton.disabled = false;
                }
            });
            
            // Check SMS quota
            async function checkQuota() {
                try {
                    const response = await fetch('/api/sms/quota');
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        quotaCard.classList.remove('d-none');
                        
                        if (result.quota.success) {
                            const quotaData = result.quota;
                            quotaInfo.innerHTML = `
                                <div class="alert alert-info mb-0">
                                    <strong>SMS Quota Information:</strong><br>
                                    <ul class="mb-0">
                                        <li>Quota Remaining: ${quotaData.quotaRemaining || 'Unknown'}</li>
                                        <li>Quota Reset: ${new Date(quotaData.quotaReset * 1000).toLocaleString() || 'Unknown'}</li>
                                    </ul>
                                </div>
                            `;
                        } else {
                            quotaInfo.innerHTML = `
                                <div class="alert alert-warning mb-0">
                                    <strong>SMS Quota Information:</strong><br>
                                    Could not retrieve quota information.
                                </div>
                            `;
                        }
                    } else {
                        quotaCard.classList.add('d-none');
                    }
                } catch (error) {
                    console.error('Error checking quota:', error);
                    quotaCard.classList.add('d-none');
                }
            }
            
            // Update SMS history display
            function updateSmsHistory() {
                if (smsHistoryItems.length === 0) {
                    smsHistory.innerHTML = `
                        <div class="alert alert-info">
                            Send an SMS to see the history here. History is only stored for this session.
                        </div>
                    `;
                    return;
                }
                
                let historyHtml = '';
                
                smsHistoryItems.forEach((item, index) => {
                    const success = item.response && item.response.status === 'success';
                    const statusClass = success ? 'success' : 'danger';
                    const statusIcon = success ? 'check-circle-fill' : 'x-circle-fill';
                    
                    historyHtml += `
                        <div class="alert alert-${statusClass} alert-dismissible fade show mb-2" role="alert">
                            <div><strong>${item.timestamp}</strong> - To: ${item.phone}</div>
                            <div class="mt-1"><strong>Q:</strong> ${item.query}</div>
                            <div class="mt-1"><strong>A:</strong> ${item.response.message || 'No response'}</div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" 
                                    onclick="event.preventDefault(); this.parentElement.remove();"></button>
                        </div>
                    `;
                });
                
                smsHistory.innerHTML = historyHtml;
            }
            
            // Show response details
            function showResponseDetails(result) {
                responseCard.classList.remove('d-none');
                
                let detailsHtml = '';
                
                // Show status and basic info
                const statusClass = result.status === 'success' ? 'success' : 'danger';
                detailsHtml += `
                    <div class="alert alert-${statusClass} mb-3">
                        <strong>Status:</strong> ${result.status}<br>
                        ${result.model_used ? `<strong>Model:</strong> ${result.model_used}<br>` : ''}
                    </div>
                `;
                
                // Show sources if available
                if (result.sources && result.sources.documents && result.sources.documents.length > 0) {
                    detailsHtml += `<h5>Sources Used</h5>`;
                    detailsHtml += formatSourcesAsHtml(result.sources);
                }
                
                // Show Textbelt API response
                if (result.textbelt_response) {
                    detailsHtml += `
                        <h5 class="mt-3">Textbelt API Response</h5>
                        <pre class="bg-light p-3 rounded">${JSON.stringify(result.textbelt_response, null, 2)}</pre>
                    `;
                }
                
                responseDetails.innerHTML = detailsHtml;
            }
            
            // Format sources as HTML
            function formatSourcesAsHtml(sources) {
                if (!sources || !sources.documents || sources.documents.length === 0) {
                    return '<p>No sources used.</p>';
                }
                
                // Use the sources.js utility function if available
                if (typeof formatSourceReferences === 'function') {
                    return formatSourceReferences(sources);
                }
                
                // Fallback implementation
                let html = '<div class="sources-list">';
                
                sources.documents.forEach((doc, index) => {
                    const metadata = sources.metadatas && sources.metadatas[index];
                    const filename = metadata && metadata.filename ? metadata.filename : 'Unknown source';
                    
                    html += `
                        <div class="source-item mb-3">
                            <div class="source-header mb-1">
                                <strong>${filename}</strong>
                            </div>
                            <div class="source-content p-2 bg-light rounded">
                                ${doc}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                return html;
            }
            
            // Helper function to show alerts
            function showAlert(message, type = 'info') {
                const alertHtml = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                
                // Insert alert at top of the form
                const firstChild = smsForm.firstChild;
                const alertElement = document.createElement('div');
                alertElement.innerHTML = alertHtml;
                smsForm.insertBefore(alertElement.firstChild, firstChild);
                
                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    const alerts = smsForm.querySelectorAll('.alert');
                    if (alerts.length > 0) {
                        alerts[0].remove();
                    }
                }, 5000);
            }
        });
    </script>
</body>
</html>